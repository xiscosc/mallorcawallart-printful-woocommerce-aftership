import { handler } from '../../src/lambda/update-wordpress.lambda'
import { when } from 'jest-when'
import { getWordpressOrder } from '../../src/client/wordpress.client'

jest.mock('../../src/client/wordpress.client')
const eventStr =
  '{\n    "eventId": "f20c81f7-6459-4f49-8478-e3814b047e21",\n    "created": 1663255379,\n    "data": {\n     "order": {\n      "branding_items": [],\n      "can_change_hold": false,\n      "costs": {\n       "additional_fee": "0.00",\n       "currency": "EUR",\n       "digitization": "0.00",\n       "discount": "6.18",\n       "fulfillment_fee": "0.00",\n       "shipping": "5.24",\n       "subtotal": "30.90",\n       "tax": "0.00",\n       "total": "36.25",\n       "vat": "6.29"\n      },\n      "created": 1663082424,\n      "dashboard_url": "https://www.printful.com/dashboard?order_id=81018100",\n      "error": null,\n      "errorCode": 0,\n      "external_id": "3659",\n      "gift": null,\n      "has_discontinued_items": false,\n      "id": 81018100,\n      "incomplete_items": [],\n      "is_sample": true,\n      "items": [\n       {\n        "discontinued": false,\n        "external_id": "72",\n        "external_variant_id": null,\n        "files": [\n         {\n          "created": 1663053448,\n          "dpi": 150,\n          "filename": "22x22_pillow_template_Data-Set-39.jpg",\n          "hash": "eee47a2d911516c7615a5e237190fd6c",\n          "height": 3450,\n          "id": 465803428,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/eee/eee47a2d911516c7615a5e237190fd6c_preview.png",\n          "size": 16799786,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/eee/eee47a2d911516c7615a5e237190fd6c_thumb.png",\n          "type": "default",\n          "url": null,\n          "visible": true,\n          "width": 3450\n         },\n         {\n          "created": 1663053448,\n          "dpi": 150,\n          "filename": "22x22_pillow_template_Data-Set-39.jpg",\n          "hash": "eee47a2d911516c7615a5e237190fd6c",\n          "height": 3450,\n          "id": 465803428,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/eee/eee47a2d911516c7615a5e237190fd6c_preview.png",\n          "size": 16799786,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/eee/eee47a2d911516c7615a5e237190fd6c_thumb.png",\n          "type": "back",\n          "url": null,\n          "visible": true,\n          "width": 3450\n         },\n         {\n          "created": 1663082007,\n          "dpi": null,\n          "filename": "all-over-print-premium-pillow-case-22x22-front-63209e1a9bc02.jpg",\n          "hash": "047812e04a8b620faca0ee5a53da10f0",\n          "height": 2000,\n          "id": 465911967,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/047/047812e04a8b620faca0ee5a53da10f0_preview.png",\n          "size": 2038032,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/047/047812e04a8b620faca0ee5a53da10f0_thumb.png",\n          "type": "preview",\n          "url": null,\n          "visible": false,\n          "width": 2000\n         }\n        ],\n        "id": 54362740,\n        "name": "All-Over Print Premium Pillow Case (22″×22″)",\n        "options": [\n         {\n          "id": "stitch_color",\n          "value": "black"\n         }\n        ],\n        "out_of_stock": false,\n        "price": "15.95",\n        "product": {\n         "image": "https://files.cdn.printful.com/products/215/11078_1581582791.jpg",\n         "name": "All-Over Print Premium Pillow Case 22″×22″",\n         "product_id": 215,\n         "variant_id": 11078\n        },\n        "quantity": 1,\n        "retail_price": null,\n        "sku": null,\n        "sync_variant_id": null,\n        "variant_id": 11078\n       },\n       {\n        "discontinued": false,\n        "external_id": null,\n        "external_variant_id": null,\n        "files": [\n         {\n          "created": 1663053316,\n          "dpi": 150,\n          "filename": "22x22_pillow_template_Data-Set-26.jpg",\n          "hash": "4c87c34bbbb841fe67a8b6fb36794b9f",\n          "height": 3450,\n          "id": 465803080,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/4c8/4c87c34bbbb841fe67a8b6fb36794b9f_preview.png",\n          "size": 15604639,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/4c8/4c87c34bbbb841fe67a8b6fb36794b9f_thumb.png",\n          "type": "default",\n          "url": null,\n          "visible": true,\n          "width": 3450\n         },\n         {\n          "created": 1663053316,\n          "dpi": 150,\n          "filename": "22x22_pillow_template_Data-Set-26.jpg",\n          "hash": "4c87c34bbbb841fe67a8b6fb36794b9f",\n          "height": 3450,\n          "id": 465803080,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/4c8/4c87c34bbbb841fe67a8b6fb36794b9f_preview.png",\n          "size": 15604639,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/4c8/4c87c34bbbb841fe67a8b6fb36794b9f_thumb.png",\n          "type": "back",\n          "url": null,\n          "visible": true,\n          "width": 3450\n         },\n         {\n          "created": 1663082221,\n          "dpi": null,\n          "filename": "all-over-print-premium-pillow-case-18x18-front-63209ef04b467.jpg",\n          "hash": "811ce6994899c7674da7882afbee9a47",\n          "height": 2000,\n          "id": 465914091,\n          "mime_type": "image/jpeg",\n          "preview_url": "https://files.cdn.printful.com/files/811/811ce6994899c7674da7882afbee9a47_preview.png",\n          "size": 1397787,\n          "status": "ok",\n          "thumbnail_url": "https://files.cdn.printful.com/files/811/811ce6994899c7674da7882afbee9a47_thumb.png",\n          "type": "preview",\n          "url": null,\n          "visible": false,\n          "width": 2000\n         }\n        ],\n        "id": 54362741,\n        "name": "All-Over Print Premium Pillow Case (18″×18″)",\n        "options": [\n         {\n          "id": "stitch_color",\n          "value": "white"\n         }\n        ],\n        "out_of_stock": false,\n        "price": "14.95",\n        "product": {\n         "image": "https://files.cdn.printful.com/products/215/9516_1581582743.jpg",\n         "name": "All-Over Print Premium Pillow Case 18″×18″",\n         "product_id": 215,\n         "variant_id": 9516\n        },\n        "quantity": 1,\n        "retail_price": null,\n        "sku": null,\n        "sync_variant_id": null,\n        "variant_id": 9516\n       }\n      ],\n      "needs_approval": false,\n      "notes": null,\n      "not_synced": false,\n      "packing_slip": null,\n      "recipient": {\n       "address1": "Berlagelaan 7E",\n       "address2": null,\n       "city": "Haarlem",\n       "company": "mallorcawallart",\n       "country_code": "NL",\n       "country_name": "Netherlands",\n       "email": null,\n       "name": "Mar Fernandez Salamanca",\n       "phone": "+31651386259",\n       "state_code": null,\n       "state_name": null,\n       "tax_number": null,\n       "zip": "2033XS"\n      },\n      "retail_costs": {\n       "currency": "EUR",\n       "discount": null,\n       "shipping": null,\n       "subtotal": "0.00",\n       "tax": null,\n       "total": null,\n       "vat": null\n      },\n      "shipping": "STANDARD",\n      "shipping_service_name": "Flat Rate (2-4 business days after fulfillment)",\n      "status": "fulfilled",\n      "store": 8603183,\n      "updated": 1663255379\n     },\n     "shipment": {\n      "can_change_hold": false,\n      "carrier": "CORREOS",\n      "created": 1663255379,\n      "id": 35089461,\n      "items": [\n       {\n        "item_id": 54362740,\n        "picked": 0,\n        "printed": 1,\n        "quantity": 1,\n        "steps": []\n       }\n      ],\n      "location": "EU",\n      "packing_slip_url": "https://www.printful.com/dashboard/default/packing-slip?shipmentId=35089461",\n      "reshipment": false,\n      "service": "Latvian Postal Services Standard Trackable",\n      "shipped_at": 1663255379,\n      "ship_date": "2022-09-15",\n      "status": "shipped",\n      "tracking_number": "PQ6B4C0200052300146758S",\n      "tracking_url": "https://myorders.co/tracking/35089461/LY040730569LV"\n     }\n    },\n    "retries": 3,\n    "store": 8603183,\n    "type": "package_shipped"\n   }'
const orderStr =
  '{\n    "id": 3659,\n    "parent_id": 0,\n    "status": "processing",\n    "currency": "EUR",\n    "version": "6.8.0",\n    "prices_include_tax": true,\n    "date_created": "2022-09-19T19:48:37",\n    "date_modified": "2022-09-19T21:02:21",\n    "discount_total": "0.00",\n    "discount_tax": "0.00",\n    "shipping_total": "4.00",\n    "shipping_tax": "0.84",\n    "cart_tax": "0.17",\n    "total": "5.84",\n    "total_tax": "1.01",\n    "customer_id": 6,\n    "order_key": "wc_order_Bf9rXRhp1bnTy",\n    "billing": {\n        "first_name": "Xisco",\n        "last_name": "Sastre",\n        "company": "",\n        "address_1": "Cami Son Llebre",\n        "address_2": "",\n        "city": "Marratxi",\n        "state": "PM",\n        "postcode": "07141",\n        "country": "ES",\n        "email": "xiscosastre@gmail.com",\n        "phone": "0637553670"\n    },\n    "shipping": {\n        "first_name": "Xisco",\n        "last_name": "Sastre",\n        "company": "",\n        "address_1": "Cami Son Llebre",\n        "address_2": "",\n        "city": "Marratxi",\n        "state": "PM",\n        "postcode": "07141",\n        "country": "ES",\n        "phone": ""\n    },\n    "payment_method": "woocommerce_payments",\n    "payment_method_title": "Visa credit card",\n    "transaction_id": "pi_3Ljo512HtyqAlPul0IeVuuHK",\n    "customer_ip_address": "188.26.215.228",\n    "customer_user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36",\n    "created_via": "checkout",\n    "customer_note": "",\n    "date_completed": null,\n    "date_paid": "2022-09-19T19:48:48",\n    "cart_hash": "ee92acf5aab87f6a62e84d3296b528a6",\n    "number": "3659",\n    "meta_data": [\n        {\n            "id": 39964,\n            "key": "is_vat_exempt",\n            "value": "no"\n        },\n        {\n            "id": 39965,\n            "key": "_intent_id",\n            "value": "pi_3Ljo512HtyqAlPul0IeVuuHK"\n        },\n        {\n            "id": 39966,\n            "key": "_intention_status",\n            "value": "succeeded"\n        },\n        {\n            "id": 39967,\n            "key": "_stripe_customer_id",\n            "value": "cus_MKs9X5CCT9kfSe"\n        },\n        {\n            "id": 39968,\n            "key": "_wcpay_intent_currency",\n            "value": "EUR"\n        },\n        {\n            "id": 39970,\n            "key": "_charge_id",\n            "value": "ch_3Ljo512HtyqAlPul0X9IigWO"\n        },\n        {\n            "id": 39971,\n            "key": "_payment_method_id",\n            "value": "pm_1Ljo5H2HtyqAlPulxQByvTas"\n        },\n        {\n            "id": 39978,\n            "key": "_new_order_email_sent",\n            "value": "true"\n        },\n        {\n            "id": 39980,\n            "key": "_charge_id",\n            "value": "ch_3Ljo512HtyqAlPul0X9IigWO"\n        },\n        {\n            "id": 39981,\n            "key": "_payment_method_id",\n            "value": "pm_1Ljo5H2HtyqAlPulxQByvTas"\n        },\n        {\n            "id": 39983,\n            "key": "_aftership_migrated",\n            "value": "ok"\n        },\n        {\n            "id": 39984,\n            "key": "_aftership_tracking_items",\n            "value": []\n        }\n    ],\n    "line_items": [\n        {\n            "id": 72,\n            "name": "MOCKUP - PAYMENT",\n            "product_id": 2015,\n            "variation_id": 0,\n            "quantity": 1,\n            "tax_class": "",\n            "subtotal": "0.83",\n            "subtotal_tax": "0.17",\n            "total": "0.83",\n            "total_tax": "0.17",\n            "taxes": [\n                {\n                    "id": 1,\n                    "total": "0.173554",\n                    "subtotal": "0.173554"\n                }\n            ],\n            "meta_data": [],\n            "sku": "",\n            "price": 0.826446,\n            "image": {\n                "id": "",\n                "src": ""\n            },\n            "parent_name": null\n        }\n    ],\n    "tax_lines": [\n        {\n            "id": 74,\n            "rate_code": "STANDARD-1",\n            "rate_id": 1,\n            "label": "Standard",\n            "compound": false,\n            "tax_total": "0.17",\n            "shipping_tax_total": "0.84",\n            "rate_percent": 21,\n            "meta_data": []\n        }\n    ],\n    "shipping_lines": [\n        {\n            "id": 73,\n            "method_title": "Flat rate",\n            "method_id": "flat_rate",\n            "instance_id": "4",\n            "total": "4.00",\n            "total_tax": "0.84",\n            "taxes": [\n                {\n                    "id": 1,\n                    "total": "0.84",\n                    "subtotal": ""\n                }\n            ],\n            "meta_data": [\n                {\n                    "id": 554,\n                    "key": "Items",\n                    "value": "MOCKUP - PAYMENT &times; 1",\n                    "display_key": "Items",\n                    "display_value": "MOCKUP - PAYMENT &times; 1"\n                }\n            ]\n        }\n    ],\n    "fee_lines": [],\n    "coupon_lines": [],\n    "refunds": [],\n    "payment_url": "https://wp.mallorcawallart.com/checkout/order-pay/3659/?pay_for_order=true&key=wc_order_Bf9rXRhp1bnTy",\n    "is_editable": false,\n    "needs_payment": false,\n    "needs_processing": true,\n    "date_created_gmt": "2022-09-19T17:48:37",\n    "date_modified_gmt": "2022-09-19T19:02:21",\n    "date_completed_gmt": null,\n    "date_paid_gmt": "2022-09-19T17:48:48",\n    "currency_symbol": "€",\n    "_links": {\n        "self": [\n            {\n                "href": "https://wp.mallorcawallart.com/wp-json/wc/v3/orders/3659"\n            }\n        ],\n        "collection": [\n            {\n                "href": "https://wp.mallorcawallart.com/wp-json/wc/v3/orders"\n            }\n        ],\n        "customer": [\n            {\n                "href": "https://wp.mallorcawallart.com/wp-json/wc/v3/customers/6"\n            }\n        ]\n    }\n}'

test('Update event', () => {
  when(getWordpressOrder).mockResolvedValue(JSON.parse(orderStr))
  handler(JSON.parse(eventStr))
})
